<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
	<id>Suki:PrivateTopics</id>
	<name>Private Topics</name>
	<version>1.0</version>
	<file name="$sourcedir/Display.php">
		<operation>
			<search position="replace"><![CDATA[// Load the proper template and/or sub template.]]></search>
			<add><![CDATA[/* PrivateTopics mod */
	if (!empty($modSettings['PrivateTopics_enable']))
	{
		$pt = new PrivateTopics($topic);
		$ptArray = $pt->doGet();
		$ptTools = $pt->doTools();
		$ptBoard = $pt->doBoard($board);
		$ptPermissionsSee = $pt->doPermissionsSee();

		if ($ptPermissionsSee == false && is_array($ptArray))
			if ($ptBoard && !in_array($user_info['id'], $ptArray))
				fatal_lang_error('PrivateTopics_redirect', false);
	}
	/* PrivateTopics mod */

	// Load the proper template and/or sub template.]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Who.php">
		<operation>
			<search position="replace"><![CDATA[// Show the topic's subject for each of the actions.
			foreach ($topic_ids[$row['id_topic']] as $k => $session_text)
				$data[$k] = sprintf($session_text, $row['id_topic'], censorText($row['subject']));]]></search>
			<add><![CDATA[// Show the topic's subject for each of the actions.
			foreach ($topic_ids[$row['id_topic']] as $k => $session_text)
			{
				/* PrivateTopics mod */
				if (!empty($modSettings['PrivateTopics_enable']))
				{
					$pt = new PrivateTopics($row['id_topic']);
					$ptArray = $pt->doGet();
					$ptTools = $pt->doTools();
					$ptPermissionsSee = $pt->doPermissionsSee();

					if ($ptPermissionsSee == false && is_array($ptArray))
						if (!in_array($user_info['id'], $ptArray))
							unset($data[$k]);

					else
						$data[$k] = sprintf($session_text, $row['id_topic'], censorText($row['subject']));
				}

				else
					$data[$k] = sprintf($session_text, $row['id_topic'], censorText($row['subject']));
			}]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Profile-View.php">
		<operation>
			<search position="replace"><![CDATA[t.approved, m.body, m.smileys_enabled, m.subject, m.poster_time, m.id_topic, m.id_msg]]></search>
			<add><![CDATA[t.approved, m.body, m.smileys_enabled, m.subject, m.poster_time, m.id_topic, m.id_msg, pt.topic_id, pt.users]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[INNER JOIN {db_prefix}messages AS m ON (m.id_msg = t.id_first_msg)]]></search>
			<add><![CDATA[INNER JOIN {db_prefix}messages AS m ON (m.id_msg = t.id_first_msg)
					LEFT JOIN {db_prefix}private_topics AS pt ON (pt.topic_id = m.id_topic)]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[ORDER BY t.id_first_msg ' . ($reverse ? 'ASC' : 'DESC') . ']]></search>
			<add><![CDATA['. (!empty($modSettings['PrivateTopics_enable']) && !allowedTo('can_always_see_private_topics') ? 'AND (pt.users IS NULL OR FIND_IN_SET("'. ($user_info['id']) .'", pt.users))' : '') .'
				ORDER BY t.id_first_msg ' . ($reverse ? 'ASC' : 'DESC') . ']]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[b.id_board, b.name AS bname, c.id_cat, c.name AS cname, m.id_topic, m.id_msg,]]></search>
			<add><![CDATA[b.id_board, b.name AS bname, c.id_cat, c.name AS cname, m.id_topic, m.id_msg, pt.topic_id, pt.users,]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
				WHERE m.id_member = {int:current_member}' . (!empty($board) ? '
					AND b.id_board = {int:board}' : '') . (empty($range_limit) ? '' : '
					AND ' . $range_limit) . '
					AND {query_see_board}' . (!$modSettings['postmod_active'] || $context['user']['is_owner'] ? '' : '
					AND t.approved = {int:is_approved} AND m.approved = {int:is_approved}') . '
				ORDER BY m.id_msg ' . ($reverse ? 'ASC' : 'DESC') . ']]></search>
			<add><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
					LEFT JOIN {db_prefix}private_topics AS pt ON (pt.topic_id = m.id_topic)
				WHERE m.id_member = {int:current_member}' . (!empty($board) ? '
					AND b.id_board = {int:board}' : '') . (empty($range_limit) ? '' : '
					AND ' . $range_limit) . '
					AND {query_see_board}' . (!$modSettings['postmod_active'] || $context['user']['is_owner'] ? '' : '
					AND t.approved = {int:is_approved} AND m.approved = {int:is_approved}') . '
					'. (!empty($modSettings['PrivateTopics_enable']) && !allowedTo('can_always_see_private_topics') ? 'AND (pt.users IS NULL OR FIND_IN_SET("'. ($user_info['id']) .'", pt.users))' : '') .'
				ORDER BY m.id_msg ' . ($reverse ? 'ASC' : 'DESC') . ']]></add>
		</operation>
	</file>

	<file name="$sourcedir/Printpage.php">
		<operation>
			<search position="replace"><![CDATA[// Whatever happens don't index this]]></search>
			<add><![CDATA[/* PrivateTopics mod */
	if (!empty($modSettings['PrivateTopics_enable']))
	{
		$pt = new PrivateTopics($topic);
		$ptArray = $pt->doGet();
		$ptTools = $pt->doTools();
		$ptBoard = $pt->doBoard($board_info['id']);
		$ptPermissionsSee = $pt->doPermissionsSee();

		if ($ptPermissionsSee == false && is_array($ptArray))
			if ($ptBoard && !in_array($user_info['id'], $ptArray))
				fatal_lang_error('PrivateTopics_redirect', false);
	}
	/* PrivateTopics mod */

	// Whatever happens don't index this.]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Recent.php">
		<operation>
			<search position="replace"><![CDATA[m.id_msg, m.subject, m.smileys_enabled, m.poster_time, m.body, m.id_topic, t.id_board, b.id_cat,]]></search>
			<add><![CDATA[m.id_msg, m.subject, m.smileys_enabled, m.poster_time, m.body, m.id_topic, t.id_board, b.id_cat, pt.topic_id, pt.users,]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[WHERE m.id_msg IN ({array_int:message_list})]]></search>
			<add><![CDATA[LEFT JOIN {db_prefix}private_topics AS pt ON (pt.topic_id = m.id_topic)
		WHERE m.id_msg IN ({array_int:message_list})
			'. (!empty($modSettings['PrivateTopics_enable']) && !allowedTo('can_always_see_private_topics') ? 'AND (pt.users IS NULL OR FIND_IN_SET("'. ($user_info['id']) .'", pt.users))' : '') .']]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[ms.id_topic, t.id_board, b.name AS bname,]]></search>
			<add><![CDATA[ms.id_topic, t.id_board, b.name AS bname, pt.topic_id, pt.users,]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[WHERE b.' . $query_this_board . ']]></search>
			<add><![CDATA[LEFT JOIN {db_prefix}private_topics AS pt ON (pt.topic_id = t.id_topic)
			WHERE b.' . $query_this_board . '
				'. (!empty($modSettings['PrivateTopics_enable']) && !allowedTo('can_always_see_private_topics') ? 'AND (pt.users IS NULL OR FIND_IN_SET("'. ($user_info['id']) .'", pt.users))' : '') .']]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[WHERE t.' . $query_this_board . ']]></search>
			<add><![CDATA[LEFT JOIN {db_prefix}private_topics AS pt ON (pt.topic_id = t.id_topic)
			WHERE t.' . $query_this_board . '
				'. (!empty($modSettings['PrivateTopics_enable']) && !allowedTo('can_always_see_private_topics') ? 'AND (pt.users IS NULL OR FIND_IN_SET("'. ($user_info['id']) .'", pt.users))' : '') .']]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[WHERE t.' . $query_this_board . ($context['showing_all_topics'] && !empty($earliest_msg) ? '
				AND t.id_last_msg > {int:earliest_msg}' : (!$context['showing_all_topics'] && empty($_SESSION['first_login']) ? '
				AND t.id_last_msg > {int:id_msg_last_visit}' : '')) . ']]></search>
			<add><![CDATA[LEFT JOIN {db_prefix}private_topics AS pt ON (pt.topic_id = t.id_topic)
			WHERE t.' . $query_this_board . ($context['showing_all_topics'] && !empty($earliest_msg) ? '
				AND t.id_last_msg > {int:earliest_msg}' : (!$context['showing_all_topics'] && empty($_SESSION['first_login']) ? '
				AND t.id_last_msg > {int:id_msg_last_visit}' : '')) . '
				'. (!empty($modSettings['PrivateTopics_enable']) && !allowedTo('can_always_see_private_topics') ? 'AND (pt.users IS NULL OR FIND_IN_SET("'. ($user_info['id']) .'", pt.users))' : '') .']]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[WHERE t.id_topic IN ({array_int:topic_list})]]></search>
			<add><![CDATA[	LEFT JOIN {db_prefix}private_topics AS pt ON (pt.topic_id = t.id_topic)
			WHERE t.id_topic IN ({array_int:topic_list})
				'. (!empty($modSettings['PrivateTopics_enable']) && !allowedTo('can_always_see_private_topics') ? 'AND (pt.users IS NULL OR FIND_IN_SET("'. ($user_info['id']) .'", pt.users))' : '') .']]></add>
		</operation>
	</file>

	<file name="$sourcedir/Subs-BoardIndex.php">
		<operation>
			<search position="replace"><![CDATA[return $boardIndexOptions['include_categories'] ? $categories : $this_category;]]></search>
			<add><![CDATA[/* PrivateTopics mod */
		$ptTrue = false;

		if (!empty($modSettings['PrivateTopics_enable']) && !empty($context['latest_post']['topic']))
		{
			$pt = new PrivateTopics($context['latest_post']['topic']);
			$ptCache = $pt->doGet();

			if (!empty($ptCache) && is_array($ptCache))
				if (!in_array($user_info['id'], $ptCache))
					$context['latest_post'] = array();
		}
		/* PrivateTopics mod */

	return $boardIndexOptions['include_categories'] ? $categories : $this_category;]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Subs-Recent.php">
		<operation>
			<search position="replace"><![CDATA[m.poster_time, m.subject, m.id_topic, m.id_member, m.id_msg,]]></search>
			<add><![CDATA[m.poster_time, m.subject, m.id_topic, m.id_member, m.id_msg, pt.topic_id, pt.users,]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[WHERE m.id_msg >= {int:likely_max_msg}]]></search>
			<add><![CDATA[LEFT JOIN {db_prefix}private_topics AS pt ON (pt.topic_id = m.id_topic)
		WHERE m.id_msg >= {int:likely_max_msg}
			'. (!empty($modSettings['PrivateTopics_enable']) && !allowedTo('can_always_see_private_topics') ? 'AND (pt.users IS NULL OR FIND_IN_SET("'. ($user_info['id']) .'", pt.users))' : '') .']]></add>
		</operation>
	</file>

	<file name="$sourcedir/Search.php">
		<operation>
			<search position="replace"><![CDATA[m.id_msg, m.subject, m.poster_name, m.poster_email, m.poster_time, m.id_member,]]></search>
			<add><![CDATA[m.id_msg, m.subject, m.poster_name, m.poster_email, m.poster_time, m.id_member, pt.topic_id, pt.users,]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[WHERE m.id_msg IN ({array_int:message_list})' . ($modSettings['postmod_active'] ? '
				AND m.approved = {int:is_approved}' : '') . '
			ORDER BY FIND_IN_SET(m.id_msg, {string:message_list_in_set})]]></search>
			<add><![CDATA[LEFT JOIN {db_prefix}private_topics AS pt ON (pt.topic_id = m.id_topic)
			WHERE m.id_msg IN ({array_int:message_list})' . ($modSettings['postmod_active'] ? '
				AND m.approved = {int:is_approved}' : '') . '
				'. (!empty($modSettings['PrivateTopics_enable']) && !allowedTo('can_always_see_private_topics') ? 'AND (pt.users IS NULL OR FIND_IN_SET("'. ($user_info['id']) .'", pt.users))' : '') .'
			ORDER BY FIND_IN_SET(m.id_msg, {string:message_list_in_set})]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Post.php">
		<operation>
			<search position="after"><![CDATA[// Check if it's locked.  It isn't locked if no topic is specified.]]></search>
			<add><![CDATA[/* PrivateTopics mod */
	if (!empty($modSettings['PrivateTopics_enable']) && !empty($topic) && !empty($board))
	{
		$pt = new PrivateTopics($topic);
		$ptArray = $pt->doGet();
		$ptTools = $pt->doTools();
		$ptBoard = $pt->doBoard($board);
		$ptPermissionsSee = $pt->doPermissionsSee();

		if ($ptPermissionsSee == false && is_array($ptArray))
			if ($ptBoard && !in_array($user_info['id'], $ptArray))
				fatal_lang_error('PrivateTopics_redirect', false);
	}
	/* PrivateTopics mod */

	// Check if it's locked.  It isn't locked if no topic is specified.]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[// Set the destinaton.]]></search>
			<add><![CDATA[/* PrivateTopics mod */
		if (!empty($topic) && !empty($modSettings['PrivateTopics_enable']))
		{
				$pt = new PrivateTopics($topic);
				$ptArray = $pt->doGet();
				$ptTools = $pt->doTools();
				$ptBoard = $pt->doBoard($board);
				$ptCanSet = $pt->doPermissionsSet();

				if (!empty($ptBoard) && $ptCanSet && is_array($ptArray))
				{
					$context['ptenable'] = $ptArray != 'no';
					$context['ptusers'] = implode(',', $ptArray);
				}
		}

		else
		{
			$context['ptenable'] = false;
			$context['ptusers'] = array();

		}
		/* PrivateTopics mod */

		// Set the destinaton.]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[// This is an already existing message. Edit it.]]></search>
			<add><![CDATA[/* PrivateTopics mod */
	$ptsave = false;

	if (!empty($modSettings['PrivateTopics_enable']) && !empty($_REQUEST['ptenable']))
	{
		/* Do they used the auto-suggest thing? */
		if (!empty($_POST['recipient_to']) && empty($_POST['ptusers']))
		{
			foreach ($_POST['recipient_to'] as $u)
				$ptuserstemp[$u] = (int) $u;

			foreach ($ptuserstemp as $key => $value)
				if ($value == '')
					unset($ptuserstemp[$key]);

			/* Let's include the topic creator to the array */
			$ptuserstemp[$user_info['id']] = $user_info['id'];

			$ptuserstemp2 = array_unique($ptuserstemp);

			$ptusers = implode(',', $ptuserstemp);
		}

		/* No? then do it the old way instead */
		elseif(!empty($_POST['ptusers']) && empty($_POST['recipient_to']))
		{
			$usersToLoad = array();

			$_POST['ptusers'] = explode(',', trim($_POST['ptusers']));

			foreach ($_POST['ptusers'] as $k => $v)
			{
				if (empty($v))
					unset($_POST['ptusers'][$k]);

				else
					$usersToLoad[] = trim($v);
			}

			foreach($usersToLoad as $m)
				if ($user = loadMemberData($m, false, 'minimal'))
					$ptuserstemp[$user[0]] = $user[0];

			/* Let's include the topic creator to the array */
			$ptuserstemp[$user_info['id']] = $user_info['id'];

			$ptuserstemp2 = array_unique($ptuserstemp);

			/* Done, fill up the array */
			$ptusers = implode(',', $ptuserstemp2);
		}

		/* If there was no users, then use the topic starter */
		else
			$ptusers = array($user_info['id']);

		/* Let's send a pm to every member, we dont' need to to send the pm to the topic author */
		$pmToSend = array();

		if (!empty($ptuserstemp2))
			foreach ($ptuserstemp2 as $uk => $uv)
				if ($uv != $user_info['id'])
					$pmToSend[] = $uv;

		$pt = new PrivateTopics($topicOptions['id'], $ptusers);
		$ptBoard = $pt->doBoard($topicOptions['board']);
		$ptTools = $pt->doTools();

		$ptsave = true;
	}

	// This is an already existing message. Edit it.]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[modifyPost($msgOptions, $topicOptions, $posterOptions);]]></search>
			<add><![CDATA[/* Only update if there is a previous record */
		if ($ptsave && $pt->doGet() != 'no')
			$pt->doUpdate($topicOptions['id']);

		modifyPost($msgOptions, $topicOptions, $posterOptions);]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[if (isset($topicOptions['id']))
			$topic = $topicOptions['id'];]]></search>
			<add><![CDATA[if (isset($topicOptions['id']))
			$topic = $topicOptions['id'];

		if ($ptsave)
		{
			$pt->doSave($topic);

			/* Send the pm */
			if (!empty($pmToSend))
			{
				global $scripturl;

				$recipients = array(
					'bcc' => array(),
					'to' => $pmToSend
				);
				$from = array(
						'id' => $user_info['id'],
						'name' => $user_info['name'],
						'username' => $user_info['username'],
					);
				$ptTopicUrl = $scripturl . '?topic=' . $topic . '.0';
				$ptUserSend = $user_info['username'];
				$ptMessage = sprintf($ptTools->getText('pm_message'), $ptTopicUrl, $ptUserSend);

				sendpm($recipients, $ptTools->getText('pm_subject'), $ptMessage, false, $from);
			}
		}]]></add>
		</operation>
	</file>

	<file name="$sourcedir/BoardIndex.php">
		<operation>
			<search position="replace"><![CDATA[$context['categories'] = getBoardIndex($boardIndexOptions);]]></search>
			<add><![CDATA[$context['categories'] = getBoardIndex($boardIndexOptions);

	/* PrivateTopics mod */
	if (!empty($modSettings['PrivateTopics_enable']) && !empty($context['categories']))
		foreach ($context['categories'] as $c)
			foreach ($c['boards'] as $b)
			{
				if (!empty($b['last_post']['topic']))
				{
					$pt = new PrivateTopics($b['last_post']['topic']);
					$ptArray = $pt->doGet();
					$ptTools = $pt->doTools();
					$ptBoard = $pt->doBoard($b['id']);
					$ptPermissionsSee = $pt->doPermissionsSee();

					/* Get the children boards too */
					if (!empty($b['children']))
						foreach ($b['children'] as $ch)
						{
							$ptchildBoards = $pt->doBoard($ch['id']);

							if ($ptPermissionsSee == false && is_array($ptArray))
								if ($ptchildBoards && !in_array($user_info['id'], $ptArray) && in_array($ch['id'], $ptchildBoards))
									unset($context['categories'][$c['id']]['boards'][$b['id']]['last_post']);
						}

					if ($ptPermissionsSee == false && is_array($ptArray))
						if ($ptBoard && !in_array($user_info['id'], $ptArray) && in_array($b['id'], $ptBoard))
							unset($context['categories'][$c['id']]['boards'][$b['id']]['last_post']);
				}

				/* We do the same for children boards */
				if (!empty($b['children']))
					foreach ($b['children'] as $ch)
						if(!empty($ch['last_post']['topic']))
						{
							$pt = new PrivateTopics($ch['last_post']['topic']);
							$ptArray = $pt->doGet();
							$ptTools = $pt->doTools();
							$ptBoard = $pt->doBoard($ch['id']);
							$ptPermissionsSee = $pt->doPermissionsSee();

							if ($ptPermissionsSee == false && is_array($ptArray))
								if ($ptBoard && !in_array($user_info['id'], $ptArray) && in_array($ch['id'], $ptBoard))
									unset($context['categories'][$c['id']]['boards'][$b['id']]['children'][$ch['id']]);
						}
			}
	/* PrivateTopics mod */]]></add>
		</operation>
	</file>

	<file name="$sourcedir/MessageIndex.php">
		<operation>
			<search position="replace"><![CDATA[t.id_topic, t.num_replies, t.locked, t.num_views, t.is_sticky, t.id_poll, t.id_previous_board,]]></search>
			<add><![CDATA[t.id_topic, t.num_replies, t.locked, t.num_views, t.is_sticky, t.id_poll, t.id_previous_board, pt.topic_id, pt.users,]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[LEFT JOIN {db_prefix}members AS meml ON (meml.id_member = ml.id_member)
				LEFT JOIN {db_prefix}members AS memf ON (memf.id_member = mf.id_member)]]></search>
			<add><![CDATA[LEFT JOIN {db_prefix}members AS meml ON (meml.id_member = ml.id_member)
				LEFT JOIN {db_prefix}private_topics AS pt ON (pt.topic_id = t.id_topic)
				LEFT JOIN {db_prefix}members AS memf ON (memf.id_member = mf.id_member)]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[ORDER BY ' . ($pre_query ? 'FIND_IN_SET(t.id_topic, {string:find_set_topics})' : (!empty($modSettings['enableStickyTopics']) ?]]></search>
			<add><![CDATA['. (!empty($modSettings['PrivateTopics_enable']) && !allowedTo('can_always_see_private_topics') ? 'AND (pt.users IS NULL OR FIND_IN_SET("'. ($user_info['id']) .'", pt.users))' : '') .'
			ORDER BY ' . ($pre_query ? 'FIND_IN_SET(t.id_topic, {string:find_set_topics})' : (!empty($modSettings['enableStickyTopics']) ? ]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[// If there are children, but no topics and no ability to post topics...]]></search>
			<add><![CDATA[/* PrivateTopics mod */
	foreach ($context['boards'] as $b)
		if (!empty($b['last_post']))
		{
			$pt = new PrivateTopics($b['last_post']['topic']);
			$ptArray = $pt->doGet();
			$ptTools = $pt->doTools();
			$ptBoard = $pt->doBoard($b['id']);
			$ptPermissionsSee = $pt->doPermissionsSee();

			if ($ptPermissionsSee == false && is_array($ptArray))
				if ($ptBoard && !in_array($user_info['id'], $ptArray) && in_array($b['id'], $ptBoard))
					unset($context['boards'][$b['id']]['last_post']);
		}
	/* PrivateTopics mod */

	// If there are children, but no topics and no ability to post topics...]]></add>
		</operation>
	</file>

	<file name="$themedir/Post.template.php">
		<operation>
			<search position="replace"><![CDATA[// Now show the subject box for this post.]]></search>
			<add><![CDATA[/* Private Topics mod */
	$pt = new PrivateTopics();
	$ptBoard = $pt->doBoard($context['current_board']);
	$ptCanSet = $pt->doPermissionsSet();

	if (!empty($modSettings['PrivateTopics_enable']) && !empty($ptBoard) && $ptCanSet)
	{
		echo '
			<dt class="clear_left">
				<span id="caption_privatetopics">', $txt['PrivateTopics_post_enable'] , ':</span>
			</dt>
			<dd>
				<input type="checkbox" id="ptenable" name="ptenable"', !empty($context['ptenable']) ? ' checked="checked"' : '', ' class="input_check" />
			</dd>';

		echo '
			<dt class="clear_left">
				<span id="caption_privatetopics">', $txt['PrivateTopics_post_message'] , ':</span>
			</dt>
			<dd>
				<input type="text" name="ptusers" id="ptusers" tabindex="', $context['tabindex']++, '" ', !isset($context['ptusers']) ? '' : ' value="' . $context['ptusers'] . '"', ' size="40" maxlength="80" class="input_text" />
			<div id="to_item_list_container"></div></dd>';
	}

	// Now show the subject box for this post.]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[}

// The template for the spellchecker.]]></search>
			<add><![CDATA[echo '
		<script type="text/javascript" src="', $settings['default_theme_url'], '/scripts/PersonalMessage.js?fin20"></script>
		<script type="text/javascript" src="', $settings['default_theme_url'], '/scripts/suggest.js?fin20"></script>
		<script type="text/javascript">

function suggestMember()
{
	omemberSuggest = new smc_AutoSuggest({
		sSelf: \'omemberSuggest\',
		sSessionId: \'', $context['session_id'], '\',
		sSessionVar: \'', $context['session_var'], '\',
		sControlId: \'ptusers\',
		sSearchType: \'member\',
		sSearchType: \'member\',
		sPostName: \'recipient_to\',
		sURLMask: \'action=profile;u=%item_id%\',
		sTextDeleteItem: \'', $txt['autosuggest_delete_item'], '\',
		bItemList: true,
		sItemListContainerId: \'to_item_list_container\',
	});
}
suggestMember();
</script>';

}

// The template for the spellchecker.]]></add>
		</operation>
	</file>

	<file name="$themedir/BoardIndex.template.php">
		<operation>
			<search position="replace"><![CDATA[if (!empty($board['last_post']['id']))
					echo '
						<p><strong>', $txt['last_post'], '</strong>  ', $txt['by'], ' ', $board['last_post']['member']['link'] , '<br />
						', $txt['in'], ' ', $board['last_post']['link'], '<br />
						', $txt['on'], ' ', $board['last_post']['time'],'
						</p>';]]></search>
			<add><![CDATA[if (!empty($board['last_post']['id']))
					echo '
						<p><strong>', $txt['last_post'], '</strong>  ', $txt['by'], ' ', $board['last_post']['member']['link'] , '<br />
						', $txt['in'], ' ', $board['last_post']['link'], '<br />
						', $txt['on'], ' ', $board['last_post']['time'],'
						</p>';

				/* If this is empty and the private topic mod is enable, then its the mods fault */
				elseif (!empty($modSettings['PrivateTopics_enable']) && empty($board['last_post']['id']))
					echo '
						<p>', !empty($modSettings['PrivateTopics_boardindex_message']) ? $modSettings['PrivateTopics_boardindex_message'] : PrivateTopics::doTools()->getText('boardindex_message_default') ,'</p>';]]></add>
		</operation>
	</file>

	<file name="$themedir/MessageIndex.template.php">
		<operation>
			<search position="replace"><![CDATA[if (!empty($board['last_post']['id']))
				echo '
						<p><strong>', $txt['last_post'], '</strong>  ', $txt['by'], ' ', $board['last_post']['member']['link'], '<br />
						', $txt['in'], ' ', $board['last_post']['link'], '<br />
						', $txt['on'], ' ', $board['last_post']['time'],'
						</p>';]]></search>
			<add><![CDATA[if (!empty($board['last_post']['id']))
				echo '
						<p><strong>', $txt['last_post'], '</strong>  ', $txt['by'], ' ', $board['last_post']['member']['link'], '<br />
						', $txt['in'], ' ', $board['last_post']['link'], '<br />
						', $txt['on'], ' ', $board['last_post']['time'],'
						</p>';

			/* If this is empty and the private topic mod is enable, then its the mods fault */
			elseif (!empty($modSettings['PrivateTopics_enable']) && empty($board['last_post']['id']))
				echo '
					<p>', !empty($modSettings['PrivateTopics_boardindex_message']) ? $modSettings['PrivateTopics_boardindex_message'] : PrivateTopics::doTools()->getText('boardindex_message_default') ,'</p>';]]></add>
		</operation>
	</file>

	<file name="$boarddir/SSI.php">
		<operation>
			<search position="replace"><![CDATA[m.poster_time, m.subject, m.id_topic, m.id_member, m.id_msg, m.id_board, b.name AS board_name,]]></search>
			<add><![CDATA[m.poster_time, m.subject, m.id_topic, m.id_member, m.id_msg, m.id_board, b.name AS board_name, pt.topic_id, pt.users,]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[INNER JOIN {db_prefix}boards AS b ON (b.id_board = m.id_board)]]></search>
			<add><![CDATA[INNER JOIN {db_prefix}boards AS b ON (b.id_board = m.id_board)
			LEFT JOIN {db_prefix}private_topics AS pt ON (pt.topic_id = m.id_topic)]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[' . (empty($query_where) ? '' : 'WHERE ' . $query_where) . ']]></search>
			<add><![CDATA[' . (empty($query_where) ? '' : 'WHERE ' . $query_where) . '
		'. (!empty($modSettings['PrivateTopics_enable']) && !allowedTo('can_always_see_private_topics') ? (empty($query_where) ? 'WHERE' : 'AND').' (pt.users IS NULL OR FIND_IN_SET("'. ($user_info['id']) .'", pt.users))' : '') .']]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[m.poster_time, ms.subject, m.id_topic, m.id_member, m.id_msg, b.id_board, b.name AS board_name, t.num_replies, t.num_views,]]></search>
			<add><![CDATA[m.poster_time, ms.subject, m.id_topic, m.id_member, m.id_msg, b.id_board, b.name AS board_name, t.num_replies, t.num_views, pt.topic_id, pt.users,]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[WHERE t.id_last_msg >= {int:min_message_id}]]></search>
			<add><![CDATA[LEFT JOIN {db_prefix}private_topics AS pt ON (pt.topic_id = t.id_topic)
		WHERE t.id_last_msg >= {int:min_message_id}
			'. (!empty($modSettings['PrivateTopics_enable']) && !allowedTo('can_always_see_private_topics') ? 'AND (pt.users IS NULL OR FIND_IN_SET("'. ($user_info['id']) .'", pt.users))' : '') .']]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[SELECT m.subject, m.id_topic, t.num_views, t.num_replies]]></search>
			<add><![CDATA[SELECT m.subject, m.id_topic, t.num_views, t.num_replies, pt.topic_id, pt.users]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[WHERE {query_wanna_see_board}' . ($modSettings['postmod_active'] ? ']]></search>
			<add><![CDATA[LEFT JOIN {db_prefix}private_topics AS pt ON (pt.topic_id = m.id_topic
		WHERE {query_wanna_see_board}' . ($modSettings['postmod_active'] ? ']]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[ORDER BY t.num_' . ($type != 'replies' ? 'views' : 'replies') . ' DESC]]></search>
			<add><![CDATA['. (!empty($modSettings['PrivateTopics_enable']) && !allowedTo('can_always_see_private_topics') ? 'AND (pt.users IS NULL OR FIND_IN_SET("'. ($user_info['id']) .'", pt.users))' : '') .'
		ORDER BY t.num_' . ($type != 'replies' ? 'views' : 'replies') . ' DESC]]></add>
		</operation>
	</file>
</modification>